<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>MCP DJ</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
  <style>
    /* â”€â”€ Design tokens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    :root {
      --bg:        #0d0d0f;
      --surface:   #18181c;
      --surface2:  #222228;
      --surface3:  #2c2c35;
      --border:    #35353f;
      --accent:    #8b5cf6;
      --accent2:   #6d28d9;
      --accent-glow: rgba(139,92,246,.25);
      --text:      #e8e8f0;
      --text-muted:#888899;
      --text-dim:  #555566;
      --green:     #22c55e;
      --yellow:    #eab308;
      --orange:    #f97316;
      --red:       #ef4444;
      --blue:      #3b82f6;
      --radius:    10px;
      --radius-sm: 6px;
    }

    /* â”€â”€ Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: var(--bg);
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      overflow: hidden;
    }
    button { cursor: pointer; font-family: inherit; }
    input, textarea { font-family: inherit; }

    /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .layout {
      display: grid;
      grid-template-rows: 56px 1fr;
      grid-template-columns: 420px 1fr;
      height: 100vh;
      gap: 0;
    }

    /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    header {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 0 20px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
    }
    .logo {
      display: flex; align-items: center; gap: 10px;
      font-size: 16px; font-weight: 700; letter-spacing: -.3px;
    }
    .logo-icon { font-size: 20px; }
    .header-stats {
      display: flex; gap: 18px; margin-left: 24px; align-items: center;
    }
    .stat { font-size: 12px; color: var(--text-muted); }
    .stat strong { color: var(--text); font-weight: 600; }
    .header-actions { margin-left: auto; display: flex; gap: 8px; }

    /* â”€â”€ Panels â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-panel {
      display: flex; flex-direction: column;
      background: var(--surface);
      border-right: 1px solid var(--border);
      overflow: hidden;
    }
    .viz-panel {
      display: flex; flex-direction: column;
      background: var(--bg);
      overflow: hidden;
    }

    /* â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .chat-header {
      padding: 14px 16px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      flex-shrink: 0;
    }
    .chat-header h2 { font-size: 13px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; }
    .messages {
      flex: 1; overflow-y: auto; padding: 16px;
      display: flex; flex-direction: column; gap: 12px;
      scrollbar-width: thin; scrollbar-color: var(--border) transparent;
    }
    .message {
      display: flex; flex-direction: column; gap: 4px;
      max-width: 92%;
    }
    .message.user { align-self: flex-end; align-items: flex-end; }
    .message.assistant { align-self: flex-start; align-items: flex-start; }
    .msg-bubble {
      padding: 10px 14px;
      border-radius: var(--radius);
      line-height: 1.6;
      font-size: 13.5px;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .message.user .msg-bubble {
      background: var(--accent);
      color: #fff;
      border-bottom-right-radius: 3px;
    }
    .message.assistant .msg-bubble {
      background: var(--surface2);
      color: var(--text);
      border-bottom-left-radius: 3px;
      border: 1px solid var(--border);
    }
    .msg-time { font-size: 11px; color: var(--text-dim); }

    /* Quick suggestion chips */
    .suggestions {
      padding: 12px 16px;
      display: flex; flex-wrap: wrap; gap: 6px;
      border-top: 1px solid var(--border);
      flex-shrink: 0;
    }
    .chip {
      padding: 5px 11px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 20px;
      font-size: 12px; color: var(--text-muted);
      cursor: pointer; transition: all .15s;
    }
    .chip:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }

    /* Chat input */
    .chat-input-area {
      padding: 12px 16px;
      border-top: 1px solid var(--border);
      display: flex; gap: 8px; align-items: flex-end;
      flex-shrink: 0;
    }
    .chat-input-wrap { flex: 1; position: relative; }
    textarea.chat-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text);
      padding: 10px 14px;
      resize: none;
      font-size: 13.5px;
      line-height: 1.5;
      min-height: 42px; max-height: 120px;
      outline: none; transition: border-color .15s;
    }
    textarea.chat-input:focus { border-color: var(--accent); }
    textarea.chat-input::placeholder { color: var(--text-dim); }
    .send-btn {
      width: 42px; height: 42px;
      background: var(--accent);
      border: none; border-radius: var(--radius);
      color: #fff; font-size: 16px;
      display: flex; align-items: center; justify-content: center;
      transition: background .15s; flex-shrink: 0;
    }
    .send-btn:hover { background: var(--accent2); }
    .send-btn:disabled { opacity: .5; cursor: not-allowed; }

    /* Typing indicator */
    .typing-indicator { display: none; align-items: center; gap: 6px; color: var(--text-muted); font-size: 12px; }
    .typing-indicator.show { display: flex; }
    .typing-dots { display: flex; gap: 3px; }
    .typing-dots span {
      width: 5px; height: 5px; border-radius: 50%;
      background: var(--text-muted); animation: bounce .8s infinite;
    }
    .typing-dots span:nth-child(2) { animation-delay: .15s; }
    .typing-dots span:nth-child(3) { animation-delay: .3s; }
    @keyframes bounce { 0%,80%,100% { transform: translateY(0); } 40% { transform: translateY(-5px); } }

    /* â”€â”€ Viz Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .viz-header {
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; justify-content: space-between;
      background: var(--surface); flex-shrink: 0;
    }
    .viz-tabs { display: flex; gap: 2px; background: var(--surface2); border-radius: var(--radius-sm); padding: 3px; }
    .viz-tab {
      padding: 5px 14px;
      border-radius: 5px; border: none;
      font-size: 12px; font-weight: 500;
      color: var(--text-muted); background: transparent; transition: all .15s;
    }
    .viz-tab.active { background: var(--surface3); color: var(--text); }
    .viz-actions { display: flex; gap: 8px; align-items: center; }

    .viz-content { flex: 1; overflow: hidden; display: flex; flex-direction: column; }

    /* Tab panes */
    .pane { display: none; flex: 1; flex-direction: column; overflow: hidden; }
    .pane.active { display: flex; }

    /* â”€â”€ Setlist Track List â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .setlist-meta {
      padding: 12px 20px;
      display: flex; gap: 16px; align-items: center;
      background: var(--surface); border-bottom: 1px solid var(--border);
      flex-shrink: 0;
    }
    .meta-stat { font-size: 12px; color: var(--text-muted); }
    .meta-stat strong { color: var(--text); }
    .harmonic-badge {
      padding: 2px 8px; border-radius: 12px;
      font-size: 11px; font-weight: 600;
      background: var(--accent-glow); color: var(--accent);
      border: 1px solid var(--accent);
    }

    .track-list { flex: 1; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--border) transparent; }
    .track-row {
      display: grid;
      grid-template-columns: 36px 1fr auto;
      gap: 10px; align-items: center;
      padding: 10px 20px;
      border-bottom: 1px solid var(--border);
      transition: background .1s; cursor: default;
    }
    .track-row:hover { background: var(--surface2); }
    .track-row.highlight { background: rgba(139,92,246,.08); border-left: 3px solid var(--accent); }

    .track-pos {
      width: 26px; height: 26px;
      background: var(--surface3);
      border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-size: 11px; font-weight: 700; color: var(--text-muted);
      flex-shrink: 0;
    }
    .track-info { min-width: 0; }
    .track-title { font-size: 13.5px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-artist { font-size: 12px; color: var(--text-muted); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .track-transition {
      font-size: 11px; color: var(--text-dim); margin-top: 2px;
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }
    .track-meta { display: flex; gap: 5px; align-items: center; flex-wrap: nowrap; }

    /* Pills */
    .pill {
      padding: 2px 7px; border-radius: 10px;
      font-size: 11px; font-weight: 600;
      white-space: nowrap;
    }
    .pill-bpm { background: rgba(59,130,246,.15); color: #60a5fa; border: 1px solid rgba(59,130,246,.3); }
    .pill-key { background: rgba(139,92,246,.15); color: #a78bfa; border: 1px solid rgba(139,92,246,.3); }
    .pill-energy.low  { background: rgba(59,130,246,.15); color: #60a5fa; border: 1px solid rgba(59,130,246,.3); }
    .pill-energy.mid  { background: rgba(234,179,8,.15); color: #fbbf24; border: 1px solid rgba(234,179,8,.3); }
    .pill-energy.high { background: rgba(239,68,68,.15); color: #f87171; border: 1px solid rgba(239,68,68,.3); }
    .pill-compat {
      font-size: 10px; padding: 2px 5px;
    }
    .pill-compat.perfect { background: rgba(34,197,94,.12); color: #4ade80; border: 1px solid rgba(34,197,94,.25); }
    .pill-compat.good    { background: rgba(234,179,8,.12); color: #fbbf24; border: 1px solid rgba(234,179,8,.25); }
    .pill-compat.ok      { background: rgba(249,115,22,.12); color: #fb923c; border: 1px solid rgba(249,115,22,.25); }
    .pill-compat.clash   { background: rgba(239,68,68,.12); color: #f87171; border: 1px solid rgba(239,68,68,.25); }

    /* â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .charts-pane { padding: 20px; gap: 20px; overflow-y: auto; }
    .chart-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
    }
    .chart-title { font-size: 12px; font-weight: 600; color: var(--text-muted); text-transform: uppercase; letter-spacing: .5px; margin-bottom: 12px; }
    .chart-wrap { position: relative; }

    /* â”€â”€ Recommendations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .rec-pane { padding: 16px 20px; gap: 10px; overflow-y: auto; }
    .rec-search { display: flex; gap: 8px; margin-bottom: 12px; flex-shrink: 0; }
    .rec-search input {
      flex: 1;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text); padding: 8px 12px; outline: none;
      font-size: 13px; transition: border-color .15s;
    }
    .rec-search input:focus { border-color: var(--accent); }
    .energy-dir-btns { display: flex; gap: 4px; }
    .dir-btn {
      padding: 6px 10px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      color: var(--text-muted); font-size: 12px;
      transition: all .15s;
    }
    .dir-btn.active.up { background: rgba(34,197,94,.15); color: var(--green); border-color: rgba(34,197,94,.4); }
    .dir-btn.active.down { background: rgba(59,130,246,.15); color: var(--blue); border-color: rgba(59,130,246,.4); }
    .dir-btn.active.maintain { background: rgba(234,179,8,.15); color: var(--yellow); border-color: rgba(234,179,8,.4); }

    .rec-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 14px;
      transition: border-color .15s, background .15s;
      cursor: pointer; flex-shrink: 0;
    }
    .rec-card:hover { border-color: var(--accent); background: var(--surface2); }
    .rec-header { display: flex; justify-content: space-between; align-items: flex-start; gap: 8px; margin-bottom: 6px; }
    .rec-rank { font-size: 11px; color: var(--text-dim); font-weight: 700; }
    .rec-title { font-size: 13.5px; font-weight: 600; }
    .rec-artist { font-size: 12px; color: var(--text-muted); }
    .rec-score-bar { display: flex; gap: 8px; align-items: center; margin-top: 8px; }
    .score-label { font-size: 11px; color: var(--text-dim); width: 60px; }
    .score-track { flex: 1; height: 4px; background: var(--surface3); border-radius: 2px; overflow: hidden; }
    .score-fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width .3s; }
    .rec-reason { font-size: 12px; color: var(--text-muted); margin-top: 6px; font-style: italic; }
    .rec-pills { display: flex; gap: 5px; margin-top: 6px; }

    /* â”€â”€ Empty / Loading states â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .empty-state {
      flex: 1; display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      gap: 12px; color: var(--text-dim); text-align: center; padding: 40px;
    }
    .empty-icon { font-size: 48px; }
    .empty-state h3 { font-size: 15px; color: var(--text-muted); font-weight: 600; }
    .empty-state p { font-size: 13px; line-height: 1.6; }

    /* â”€â”€ Buttons â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .btn {
      padding: 7px 14px;
      border-radius: var(--radius-sm);
      font-size: 13px; font-weight: 500;
      border: 1px solid transparent;
      transition: all .15s; display: inline-flex; align-items: center; gap: 6px;
    }
    .btn-primary { background: var(--accent); color: #fff; }
    .btn-primary:hover { background: var(--accent2); }
    .btn-ghost { background: transparent; border-color: var(--border); color: var(--text-muted); }
    .btn-ghost:hover { border-color: var(--accent); color: var(--accent); background: var(--accent-glow); }
    .btn-danger { background: rgba(239,68,68,.15); border-color: rgba(239,68,68,.3); color: var(--red); }
    .btn-danger:hover { background: rgba(239,68,68,.25); }
    .btn:disabled { opacity: .5; cursor: not-allowed; }

    /* â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .toast-container { position: fixed; bottom: 20px; right: 20px; display: flex; flex-direction: column; gap: 8px; z-index: 9999; }
    .toast {
      padding: 10px 16px; border-radius: var(--radius);
      font-size: 13px; font-weight: 500;
      background: var(--surface3); border: 1px solid var(--border);
      color: var(--text); box-shadow: 0 4px 20px rgba(0,0,0,.4);
      animation: slideIn .2s ease; max-width: 300px;
    }
    .toast.success { border-color: rgba(34,197,94,.4); color: var(--green); background: rgba(34,197,94,.1); }
    .toast.error { border-color: rgba(239,68,68,.4); color: var(--red); background: rgba(239,68,68,.1); }
    @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: none; } }

    /* â”€â”€ Track Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .map-controls {
      padding: 10px 16px;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      display: flex; align-items: center; gap: 10px;
      flex-shrink: 0;
    }
    .map-mode-btns {
      display: flex; gap: 3px;
      background: var(--surface2); border-radius: var(--radius-sm); padding: 3px;
    }
    .map-mode-btn {
      padding: 4px 12px; border-radius: 4px; border: none;
      font-size: 12px; font-weight: 500; color: var(--text-muted);
      background: transparent; cursor: pointer; transition: all .15s;
    }
    .map-mode-btn.active { background: var(--surface3); color: var(--text); }
    .map-mode-btn:hover:not(.active) { color: var(--accent); }
    .map-status { font-size: 12px; color: var(--text-dim); flex: 1; }
    .map-canvas-wrap { flex: 1; position: relative; overflow: hidden; }
    #map-canvas { display: block; width: 100%; height: 100%; cursor: grab; }
    #map-canvas:active { cursor: grabbing; }
    .map-tooltip {
      display: none; position: absolute;
      background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 10px 12px;
      pointer-events: none; z-index: 10; max-width: 230px;
      box-shadow: 0 4px 20px rgba(0,0,0,.55);
    }
    .map-legend {
      position: absolute; bottom: 16px; left: 16px;
      background: rgba(24,24,28,.9); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 10px 12px;
      max-width: 155px; pointer-events: none;
      backdrop-filter: blur(8px);
    }
    .map-empty {
      position: absolute; inset: 0; display: flex;
      align-items: center; justify-content: center; flex-direction: column; gap: 12px;
      background: var(--bg); color: var(--text-muted); font-size: 13px;
    }

    /* â”€â”€ Scrollbar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--surface3); }

    /* â”€â”€ Export modal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
    .modal-overlay {
      position: fixed; inset: 0; background: rgba(0,0,0,.6);
      display: none; align-items: center; justify-content: center; z-index: 1000;
    }
    .modal-overlay.show { display: flex; }
    .modal {
      background: var(--surface); border: 1px solid var(--border);
      border-radius: var(--radius); padding: 24px; width: 380px;
      box-shadow: 0 20px 60px rgba(0,0,0,.5);
    }
    .modal h3 { font-size: 16px; margin-bottom: 16px; }
    .modal label { font-size: 12px; color: var(--text-muted); display: block; margin-bottom: 6px; }
    .modal input {
      width: 100%; background: var(--surface2); border: 1px solid var(--border);
      border-radius: var(--radius-sm); color: var(--text); padding: 9px 12px;
      font-size: 13px; outline: none;
    }
    .modal input:focus { border-color: var(--accent); }
    .modal-actions { display: flex; gap: 8px; justify-content: flex-end; margin-top: 20px; }
  </style>
</head>
<body>

<div class="layout">
  <!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <header>
    <div class="logo">
      <span class="logo-icon">ğŸ›ï¸</span>
      MCP DJ
    </div>
    <div class="header-stats" id="header-stats">
      <span class="stat"><strong id="stat-tracks">â€”</strong> tracks</span>
      <span class="stat">BPM <strong id="stat-bpm">â€”</strong></span>
      <span class="stat">Top genre: <strong id="stat-genre">â€”</strong></span>
    </div>
    <div class="header-actions">
      <button class="btn btn-ghost" onclick="clearChat()">ğŸ—‘ Clear chat</button>
      <button class="btn btn-primary" id="export-btn" onclick="showExportModal()" disabled>â¬† Export to Rekordbox</button>
    </div>
  </header>

  <!-- â”€â”€ Chat Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="chat-panel">
    <div class="chat-header">
      <h2>ğŸ¤– AI DJ Assistant</h2>
      <div class="typing-indicator" id="typing">
        <span>Thinking</span>
        <div class="typing-dots"><span></span><span></span><span></span></div>
      </div>
    </div>

    <div class="messages" id="messages">
      <div class="message assistant">
        <div class="msg-bubble">
ğŸ‘‹ Hey! I'm your AI DJ assistant. I can analyze your Rekordbox library and generate harmonically-mixed setlists for you.

Try asking me:
â€¢ "Create a 2-hour tech house set at 130 BPM"
â€¢ "Build a chill deep house journey for 90 minutes"
â€¢ "What should I play after [track name]?"
â€¢ "Make a peak-time techno set"
        </div>
        <span class="msg-time">Ready</span>
      </div>
    </div>

    <div class="suggestions" id="suggestions">
      <span class="chip" onclick="useSuggestion(this)">ğŸµ 2h Tech House journey</span>
      <span class="chip" onclick="useSuggestion(this)">ğŸ”¥ Peak-time Techno set</span>
      <span class="chip" onclick="useSuggestion(this)">ğŸŒŠ Deep House chill 90min</span>
      <span class="chip" onclick="useSuggestion(this)">ğŸŒ… Warm-up set 60min</span>
      <span class="chip" onclick="useSuggestion(this)">ğŸ“ˆ Build energy set</span>
    </div>

    <div class="chat-input-area">
      <div class="chat-input-wrap">
        <textarea
          class="chat-input"
          id="chat-input"
          placeholder="Describe your setâ€¦ or drop a track name for recommendations"
          rows="1"
          onkeydown="handleKey(event)"
          oninput="autoResize(this)"
        ></textarea>
      </div>
      <button class="send-btn" id="send-btn" onclick="sendMessage()">â¤</button>
    </div>
  </section>

  <!-- â”€â”€ Visualization Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <section class="viz-panel">
    <div class="viz-header">
      <div class="viz-tabs">
        <button class="viz-tab active" onclick="switchTab('setlist', this)">Setlist</button>
        <button class="viz-tab" onclick="switchTab('charts', this)">Charts</button>
        <button class="viz-tab" onclick="switchTab('recommendations', this)">Next Track</button>
        <button class="viz-tab" onclick="switchTab('map', this)">ğŸ—º Track Map</button>
      </div>
      <div class="viz-actions" id="viz-actions">
        <span id="setlist-name-label" style="font-size:13px;color:var(--text-muted);"></span>
      </div>
    </div>

    <div class="viz-content">
      <!-- Setlist pane -->
      <div class="pane active" id="pane-setlist">
        <div id="setlist-meta" class="setlist-meta" style="display:none;"></div>
        <div class="track-list" id="track-list">
          <div class="empty-state">
            <div class="empty-icon">ğŸ§</div>
            <h3>No setlist yet</h3>
            <p>Ask the AI to create a set for you, or use the quick suggestions in the chat.</p>
          </div>
        </div>
      </div>

      <!-- Charts pane -->
      <div class="pane" id="pane-charts">
        <div class="charts-pane">
          <div class="chart-card">
            <div class="chart-title">âš¡ Energy Flow</div>
            <div class="chart-wrap" style="height:180px;">
              <canvas id="energy-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ğŸš BPM Flow</div>
            <div class="chart-wrap" style="height:140px;">
              <canvas id="bpm-chart"></canvas>
            </div>
          </div>
          <div class="chart-card">
            <div class="chart-title">ğŸ¸ Genre Distribution</div>
            <div class="chart-wrap" style="height:160px;">
              <canvas id="genre-chart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <!-- Map pane -->
      <div class="pane" id="pane-map">
        <div class="map-controls">
          <div class="map-mode-btns">
            <button class="map-mode-btn active" data-mode="energy" onclick="setMapColorMode('energy')">Energy</button>
            <button class="map-mode-btn" data-mode="genre" onclick="setMapColorMode('genre')">Genre</button>
            <button class="map-mode-btn" data-mode="bpm" onclick="setMapColorMode('bpm')">BPM</button>
            <button class="map-mode-btn" data-mode="tags" onclick="setMapColorMode('tags')">Tags</button>
          </div>
          <span class="map-status" id="map-status"></span>
          <button class="btn btn-ghost" style="font-size:12px;padding:4px 10px;" onclick="resetMapZoom()">âŸ³ Reset View</button>
          <button class="btn btn-ghost" id="rebuild-map-btn" style="font-size:12px;padding:4px 10px;" onclick="rebuildTrackMap()" title="Recompute 2D positions from scratch">âš™ Rebuild Map</button>
        </div>
        <div class="map-canvas-wrap" id="map-canvas-wrap">
          <canvas id="map-canvas"></canvas>
          <div class="map-tooltip" id="map-tooltip"></div>
          <div class="map-legend" id="map-legend"></div>
          <div class="map-empty" id="map-loading">
            <div class="typing-dots"><span></span><span></span><span></span></div>
            <span>Computing track mapâ€¦</span>
          </div>
        </div>
      </div>

      <!-- Recommendations pane -->
      <div class="pane" id="pane-recommendations">
        <div class="rec-pane">
          <div class="rec-search">
            <input
              type="text"
              id="rec-input"
              placeholder="Drop a track title or artistâ€¦"
              onkeydown="if(event.key==='Enter') getRecommendations()"
            />
            <div class="energy-dir-btns">
              <button class="dir-btn up" onclick="setEnergyDir('up', this)" title="Raise energy">â†‘</button>
              <button class="dir-btn active maintain" onclick="setEnergyDir('maintain', this)" title="Maintain energy">â†’</button>
              <button class="dir-btn down" onclick="setEnergyDir('down', this)" title="Lower energy">â†“</button>
            </div>
            <button class="btn btn-primary" onclick="getRecommendations()">Find</button>
          </div>
          <div id="rec-results">
            <div class="empty-state" style="flex:unset;padding:20px 0;">
              <div class="empty-icon">ğŸ”</div>
              <h3>Enter a track name</h3>
              <p>Type a track name above and I'll find the best tracks to play next based on harmonic compatibility and energy flow.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>
</div>

<!-- Export Modal -->
<div class="modal-overlay" id="export-modal">
  <div class="modal">
    <h3>â¬† Export to Rekordbox</h3>
    <label>Playlist Name</label>
    <input type="text" id="export-name" placeholder="My AI Set - Feb 2026" />
    <div class="modal-actions">
      <button class="btn btn-ghost" onclick="hideExportModal()">Cancel</button>
      <button class="btn btn-primary" onclick="exportSetlist()">Create Playlist</button>
    </div>
  </div>
</div>

<!-- Toast container -->
<div class="toast-container" id="toasts"></div>

<script>
// â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const state = {
  currentSetlist: null,
  currentRecs: null,
  energyDir: 'maintain',
  charts: { energy: null, bpm: null, genre: null },
  loading: false,
  mapLoaded: false,
};
let trackMap = null;

// â”€â”€ API helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function api(path, options = {}) {
  const resp = await fetch(path, {
    headers: { 'Content-Type': 'application/json' },
    ...options,
  });
  if (!resp.ok) {
    const err = await resp.text();
    throw new Error(err || resp.statusText);
  }
  return resp.json();
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  try {
    const stats = await api('/api/library/stats');
    document.getElementById('stat-tracks').textContent = stats.total?.toLocaleString() ?? 'â€”';
    const bpmRange = stats.bpm_min && stats.bpm_max
      ? `${Math.round(stats.bpm_min)}â€“${Math.round(stats.bpm_max)}`
      : 'â€”';
    document.getElementById('stat-bpm').textContent = bpmRange;
    const topGenre = stats.top_genres?.[0]?.split(' (')[0] ?? 'â€”';
    document.getElementById('stat-genre').textContent = topGenre;
  } catch (e) {
    console.warn('Could not load library stats:', e);
  }
}

// â”€â”€ Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleKey(e) {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    sendMessage();
  }
}

function autoResize(el) {
  el.style.height = 'auto';
  el.style.height = Math.min(el.scrollHeight, 120) + 'px';
}

function useSuggestion(el) {
  const input = document.getElementById('chat-input');
  input.value = el.textContent.replace(/^[^\s]+\s/, ''); // strip emoji
  autoResize(input);
  sendMessage();
}

async function sendMessage() {
  const input = document.getElementById('chat-input');
  const msg = input.value.trim();
  if (!msg || state.loading) return;

  input.value = '';
  input.style.height = 'auto';
  addMessage('user', msg);
  setLoading(true);

  try {
    const data = await api('/api/chat', {
      method: 'POST',
      body: JSON.stringify({ message: msg }),
    });

    addMessage('assistant', data.content);

    if (data.setlist) {
      state.currentSetlist = data.setlist;
      renderSetlist(data.setlist);
      renderCharts(data.setlist);
      document.getElementById('export-btn').disabled = false;
      // Auto-switch to Track Map and apply set overlay
      switchTab('map', null);
      if (trackMap) trackMap.updateSet(data.setlist);
    }
    if (data.recommendations) {
      state.currentRecs = data.recommendations;
      renderRecommendations(data.recommendations);
    }
  } catch (e) {
    addMessage('assistant', `âš ï¸ Error: ${e.message}`);
  } finally {
    setLoading(false);
  }
}

async function clearChat() {
  try {
    await api('/api/chat/clear', { method: 'POST' });
  } catch (_) {}
  document.getElementById('messages').innerHTML = `
    <div class="message assistant">
      <div class="msg-bubble">Chat cleared. Ready to create a new setlist!</div>
      <span class="msg-time">Now</span>
    </div>`;
}

function addMessage(role, content) {
  const container = document.getElementById('messages');
  const el = document.createElement('div');
  el.className = `message ${role}`;

  // Convert markdown-style bold **text**
  const formatted = content
    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.*?)\*/g, '<em>$1</em>');

  el.innerHTML = `
    <div class="msg-bubble">${formatted}</div>
    <span class="msg-time">${new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'})}</span>
  `;
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

function setLoading(on) {
  state.loading = on;
  document.getElementById('send-btn').disabled = on;
  document.getElementById('typing').classList.toggle('show', on);
}

// â”€â”€ Tab switching â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function switchTab(name, btn) {
  document.querySelectorAll('.pane').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.viz-tab').forEach(t => t.classList.remove('active'));
  document.getElementById(`pane-${name}`).classList.add('active');
  const tabs = document.querySelectorAll('.viz-tab');
  const idx = ['setlist', 'charts', 'recommendations', 'map'].indexOf(name);
  if (tabs[idx]) tabs[idx].classList.add('active');
  if (name === 'map') loadTrackMap();
}

// â”€â”€ Setlist rendering â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderSetlist(setlist) {
  // Meta bar
  const metaEl = document.getElementById('setlist-meta');
  metaEl.style.display = 'flex';
  const dur = Math.round(setlist.total_duration_seconds / 60);
  metaEl.innerHTML = `
    <div class="meta-stat"><strong>${setlist.track_count}</strong> tracks</div>
    <div class="meta-stat"><strong>${dur}</strong> min</div>
    <div class="meta-stat">Avg BPM: <strong>${setlist.avg_bpm}</strong></div>
    <div class="meta-stat">BPM: <strong>${Math.round(setlist.bpm_range[0])}â€“${Math.round(setlist.bpm_range[1])}</strong></div>
    <div class="harmonic-badge">â™ª ${Math.round(setlist.harmonic_score * 100)}% harmonic</div>
  `;

  document.getElementById('setlist-name-label').textContent = setlist.name;

  // Track list
  const listEl = document.getElementById('track-list');
  listEl.innerHTML = '';

  setlist.tracks.forEach(st => {
    const track = st.track;
    const row = document.createElement('div');
    row.className = 'track-row';

    const energyClass = !track.energy ? 'mid'
      : track.energy <= 4 ? 'low'
      : track.energy <= 7 ? 'mid' : 'high';

    const compatClass = st.transition_score >= 0.85 ? 'perfect'
      : st.transition_score >= 0.65 ? 'good'
      : st.transition_score >= 0.4 ? 'ok' : 'clash';
    const compatLabel = st.transition_score >= 0.85 ? 'âœ“'
      : st.transition_score >= 0.65 ? '~'
      : st.transition_score >= 0.4 ? 'â–³' : 'âœ—';

    const bpmDeltaStr = st.bpm_delta !== 0
      ? ` <span style="color:var(--text-dim)">${st.bpm_delta > 0 ? '+' : ''}${st.bpm_delta.toFixed(0)} BPM</span>`
      : '';

    const transitionNote = st.position > 1
      ? `<div class="track-transition">â†³ ${st.notes}${bpmDeltaStr}</div>` : '';

    row.innerHTML = `
      <div class="track-pos">${st.position}</div>
      <div class="track-info">
        <div class="track-title">${esc(track.title)}</div>
        <div class="track-artist">${esc(track.artist)}</div>
        ${transitionNote}
      </div>
      <div class="track-meta">
        ${track.bpm > 0 ? `<span class="pill pill-bpm">${Math.round(track.bpm)}</span>` : ''}
        ${track.key ? `<span class="pill pill-key">${esc(track.key)}</span>` : ''}
        ${track.energy ? `<span class="pill pill-energy ${energyClass}">E${track.energy}</span>` : ''}
        ${st.position > 1 ? `<span class="pill pill-compat ${compatClass}" title="${esc(st.key_relation)}">${compatLabel}</span>` : ''}
      </div>
    `;

    // Click to recommend next
    row.addEventListener('dblclick', () => {
      document.getElementById('rec-input').value = `${track.artist} - ${track.title}`;
      switchTab('recommendations', null);
      getRecommendations();
    });

    listEl.appendChild(row);
  });
}

// â”€â”€ Charts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderCharts(setlist) {
  if (!setlist?.tracks?.length) return;

  const labels = setlist.tracks.map(st => st.position);
  const energies = setlist.tracks.map(st => st.track.energy ?? 5);
  const bpms = setlist.tracks.map(st => st.track.bpm);
  const targetArc = energies.map((_, i) => {
    // approximate target - use the setlist's energy arc if available
    return setlist.energy_arc?.[i] ?? energies[i];
  });

  // Genre chart data
  const genreDist = setlist.genre_distribution || {};
  const genreLabels = Object.keys(genreDist);
  const genreCounts = Object.values(genreDist);

  // Energy chart
  const energyCtx = document.getElementById('energy-chart').getContext('2d');
  if (state.charts.energy) state.charts.energy.destroy();
  state.charts.energy = new Chart(energyCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Actual Energy',
          data: energies,
          borderColor: '#8b5cf6',
          backgroundColor: 'rgba(139,92,246,.12)',
          borderWidth: 2,
          fill: true,
          tension: 0.4,
          pointRadius: 3,
        },
        {
          label: 'Target',
          data: targetArc,
          borderColor: 'rgba(255,255,255,.2)',
          borderWidth: 1,
          borderDash: [4, 4],
          fill: false,
          tension: 0.4,
          pointRadius: 0,
        }
      ]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: true, labels: { color: '#888899', font: { size: 11 } } } },
      scales: {
        x: { ticks: { color: '#555566', font: { size: 10 } }, grid: { color: '#222228' } },
        y: { min: 0, max: 10, ticks: { color: '#555566', font: { size: 10 } }, grid: { color: '#222228' } }
      }
    }
  });

  // BPM chart
  const bpmCtx = document.getElementById('bpm-chart').getContext('2d');
  if (state.charts.bpm) state.charts.bpm.destroy();
  state.charts.bpm = new Chart(bpmCtx, {
    type: 'line',
    data: {
      labels,
      datasets: [{
        label: 'BPM',
        data: bpms,
        borderColor: '#3b82f6',
        backgroundColor: 'rgba(59,130,246,.08)',
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        pointRadius: 3,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: { legend: { display: false } },
      scales: {
        x: { ticks: { color: '#555566', font: { size: 10 } }, grid: { color: '#222228' } },
        y: { ticks: { color: '#555566', font: { size: 10 } }, grid: { color: '#222228' } }
      }
    }
  });

  // Genre chart
  if (genreLabels.length > 0) {
    const genreCtx = document.getElementById('genre-chart').getContext('2d');
    if (state.charts.genre) state.charts.genre.destroy();
    const palette = ['#8b5cf6','#3b82f6','#22c55e','#eab308','#f97316','#ef4444','#a78bfa','#60a5fa'];
    state.charts.genre = new Chart(genreCtx, {
      type: 'doughnut',
      data: {
        labels: genreLabels,
        datasets: [{
          data: genreCounts,
          backgroundColor: palette.slice(0, genreLabels.length),
          borderWidth: 0,
        }]
      },
      options: {
        responsive: true, maintainAspectRatio: false,
        plugins: {
          legend: { position: 'right', labels: { color: '#888899', font: { size: 11 }, padding: 10, boxWidth: 12 } }
        }
      }
    });
  }
}

// â”€â”€ Recommendations â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setEnergyDir(dir, btn) {
  state.energyDir = dir;
  document.querySelectorAll('.dir-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function getRecommendations() {
  const query = document.getElementById('rec-input').value.trim();
  if (!query) return;

  switchTab('recommendations', null);
  const recResults = document.getElementById('rec-results');
  recResults.innerHTML = '<div class="empty-state"><div class="typing-dots"><span></span><span></span><span></span></div></div>';

  try {
    const data = await api('/api/setlist/recommend', {
      method: 'POST',
      body: JSON.stringify({
        track_title: query,
        energy_direction: state.energyDir,
        limit: 8,
      }),
    });

    if (!data.length) {
      recResults.innerHTML = `<div class="empty-state"><div class="empty-icon">ğŸ”</div><h3>No results</h3><p>Couldn't find that track. Try a different name.</p></div>`;
      return;
    }

    recResults.innerHTML = '';
    data.forEach((rec, i) => {
      const track = rec.track;
      const energyClass = !track.energy ? 'mid'
        : track.energy <= 4 ? 'low'
        : track.energy <= 7 ? 'mid' : 'high';

      const card = document.createElement('div');
      card.className = 'rec-card';
      card.innerHTML = `
        <div class="rec-header">
          <div>
            <div class="rec-rank">#${i + 1}</div>
            <div class="rec-title">${esc(track.title)}</div>
            <div class="rec-artist">${esc(track.artist)}</div>
          </div>
          <div style="text-align:right; font-size:15px; font-weight:700; color:var(--accent)">${Math.round(rec.score * 100)}%</div>
        </div>
        <div class="rec-pills">
          ${track.bpm > 0 ? `<span class="pill pill-bpm">${Math.round(track.bpm)}</span>` : ''}
          ${track.key ? `<span class="pill pill-key">${esc(track.key)}</span>` : ''}
          ${track.energy ? `<span class="pill pill-energy ${energyClass}">E${track.energy}</span>` : ''}
          ${track.genre ? `<span class="pill" style="background:var(--surface3);color:var(--text-muted);border:1px solid var(--border);">${esc(track.genre)}</span>` : ''}
        </div>
        <div class="rec-score-bar">
          <span class="score-label">Harmonic</span>
          <div class="score-track"><div class="score-fill" style="width:${rec.harmonic_score * 100}%"></div></div>
        </div>
        <div class="rec-score-bar">
          <span class="score-label">Energy</span>
          <div class="score-track"><div class="score-fill" style="width:${rec.energy_score * 100}%;background:var(--yellow)"></div></div>
        </div>
        <div class="rec-score-bar">
          <span class="score-label">BPM</span>
          <div class="score-track"><div class="score-fill" style="width:${rec.bpm_score * 100}%;background:var(--blue)"></div></div>
        </div>
        <div class="rec-reason">${esc(rec.reason)}</div>
      `;
      recResults.appendChild(card);
    });
  } catch (e) {
    recResults.innerHTML = `<div class="empty-state"><div class="empty-icon">âš ï¸</div><h3>Error</h3><p>${esc(e.message)}</p></div>`;
  }
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showExportModal() {
  if (!state.currentSetlist) return;
  const now = new Date();
  document.getElementById('export-name').value =
    `AI Set â€“ ${now.toLocaleDateString('en-GB', {day:'2-digit',month:'short',year:'numeric'})}`;
  document.getElementById('export-modal').classList.add('show');
}

function hideExportModal() {
  document.getElementById('export-modal').classList.remove('show');
}

async function exportSetlist() {
  const name = document.getElementById('export-name').value.trim();
  if (!name || !state.currentSetlist) return;

  hideExportModal();
  try {
    const data = await api('/api/setlist/export', {
      method: 'POST',
      body: JSON.stringify({ setlist_id: state.currentSetlist.id, playlist_name: name }),
    });
    showToast(`âœ… Playlist "${name}" created in Rekordbox (${data.track_count} tracks)!`, 'success');
  } catch (e) {
    showToast(`âŒ Export failed: ${e.message}`, 'error');
  }
}

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = '') {
  const container = document.getElementById('toasts');
  const toast = document.createElement('div');
  toast.className = `toast ${type}`;
  toast.textContent = msg;
  container.appendChild(toast);
  setTimeout(() => toast.remove(), 4000);
}

// â”€â”€ Utils â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(str) {
  if (!str) return '';
  return String(str)
    .replace(/&/g, '&amp;')
    .replace(/</g, '&lt;')
    .replace(/>/g, '&gt;')
    .replace(/"/g, '&quot;');
}

// â”€â”€ Track Map â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

class TrackMap {
  constructor(canvas) {
    this.canvas  = canvas;
    this.ctx     = canvas.getContext('2d');
    this.tracks  = [];
    this.setIds  = {};          // trackId â†’ set position number
    this.tx = 0; this.ty = 0; this.scale = 1;
    this.mode    = 'energy';    // 'energy' | 'genre' | 'bpm' | 'tags'
    this.hovered = null;
    this._drag   = null;
    this._raf    = null;
    this._gColors = {};
    this._dpr    = window.devicePixelRatio || 1;
    this._ro     = new ResizeObserver(() => this._resize());
    this._ro.observe(canvas.parentElement);
    this._bind();
    this._resize();
  }

  // â”€â”€ Public â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  load(tracks) {
    this.tracks = tracks;
    this._buildGenreColors();
    this.resetView();
    this._draw();
  }

  updateSet(setlist) {
    this.setIds = {};
    (setlist?.tracks || []).forEach(st => {
      if (st.track?.id) this.setIds[st.track.id] = st.position;
    });
    this._draw();
  }

  resetView() {
    const w = this.canvas.width / this._dpr;
    const h = this.canvas.height / this._dpr;
    if (!this.tracks.length) {
      this.scale = Math.min(w, h) * 0.44;
      this.tx = w / 2;
      this.ty = h / 2;
    } else {
      // Fit the actual data bounding box with padding
      let xMin = Infinity, xMax = -Infinity, yMin = Infinity, yMax = -Infinity;
      for (const t of this.tracks) {
        if (t.x < xMin) xMin = t.x; if (t.x > xMax) xMax = t.x;
        if (t.y < yMin) yMin = t.y; if (t.y > yMax) yMax = t.y;
      }
      const pad  = 0.08;
      const xSpan = (xMax - xMin) * (1 + 2 * pad);
      const ySpan = (yMax - yMin) * (1 + 2 * pad);
      this.scale = Math.min(w / xSpan, h / ySpan);
      this.tx = w / 2 - ((xMin + xMax) / 2) * this.scale;
      this.ty = h / 2 - ((yMin + yMax) / 2) * this.scale;
    }
    this._draw();
  }

  setMode(mode) { this.mode = mode; this._draw(); }

  destroy() { this._ro.disconnect(); cancelAnimationFrame(this._raf); }

  // â”€â”€ Internal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  _resize() {
    const wrap = this.canvas.parentElement;
    const w = wrap.clientWidth, h = wrap.clientHeight, dpr = this._dpr;
    this.canvas.width  = w * dpr;
    this.canvas.height = h * dpr;
    this.canvas.style.width  = w + 'px';
    this.canvas.style.height = h + 'px';
    const ctx = this.ctx;
    ctx.setTransform(1, 0, 0, 1, 0, 0);
    ctx.scale(dpr, dpr);
    this.resetView();
  }

  _buildGenreColors() {
    const pal = [
      '#8b5cf6','#3b82f6','#22c55e','#eab308','#f97316',
      '#ef4444','#a78bfa','#60a5fa','#4ade80','#fbbf24',
      '#fb923c','#f87171','#e879f9','#34d399','#818cf8',
      '#c084fc','#38bdf8','#86efac','#fde68a','#fca5a5',
    ];
    const genres = [...new Set(this.tracks.map(t => t.genre || 'Other'))];
    genres.forEach((g, i) => { this._gColors[g] = pal[i % pal.length]; });
  }

  _w2s(x, y) { return { sx: x * this.scale + this.tx, sy: y * this.scale + this.ty }; }
  _s2w(sx, sy) { return { wx: (sx - this.tx) / this.scale, wy: (sy - this.ty) / this.scale }; }

  _bind() {
    const c = this.canvas;
    c.addEventListener('wheel',      e => this._wheel(e), { passive: false });
    c.addEventListener('mousedown',  e => this._down(e));
    window.addEventListener('mousemove', e => this._move(e));
    window.addEventListener('mouseup',   () => { this._drag = null; });
    c.addEventListener('mouseleave', () => {
      this.hovered = null;
      document.getElementById('map-tooltip').style.display = 'none';
      this._draw();
    });
  }

  _wheel(e) {
    e.preventDefault();
    const rect = this.canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;
    const { wx, wy } = this._s2w(mx, my);
    const f = e.deltaY < 0 ? 1.12 : 0.89;
    this.scale = Math.min(Math.max(this.scale * f, 50), 10000);
    this.tx = mx - wx * this.scale;
    this.ty = my - wy * this.scale;
    this._draw();
  }

  _down(e) {
    const rect = this.canvas.getBoundingClientRect();
    this._drag = {
      mx0: e.clientX - rect.left, my0: e.clientY - rect.top,
      tx0: this.tx, ty0: this.ty, rect,
    };
  }

  _move(e) {
    const rect = this.canvas.getBoundingClientRect();
    const mx = e.clientX - rect.left, my = e.clientY - rect.top;

    if (this._drag) {
      this.tx = this._drag.tx0 + (e.clientX - rect.left - this._drag.mx0);
      this.ty = this._drag.ty0 + (e.clientY - rect.top  - this._drag.my0);
      this._draw();
      return;
    }

    // Only run hover when canvas is hovered
    if (!this.canvas.matches(':hover')) return;

    const { wx, wy } = this._s2w(mx, my);
    const thresh = 14 / this.scale;
    let best = null, bestD = thresh;
    for (const t of this.tracks) {
      const d = Math.hypot(t.x - wx, t.y - wy);
      if (d < bestD) { bestD = d; best = t; }
    }
    if (best !== this.hovered) { this.hovered = best; this._draw(); }
    this._tooltip(best, mx, my, rect);
  }

  _tooltip(t, mx, my, rect) {
    const tip = document.getElementById('map-tooltip');
    if (!t) { tip.style.display = 'none'; return; }
    const tags  = (t.my_tags || []).slice(0, 3).join(', ');
    const eC    = !t.energy ? 'mid' : t.energy <= 4 ? 'low' : t.energy <= 7 ? 'mid' : 'high';
    tip.innerHTML = `
      <div style="font-weight:700;font-size:13px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(t.title||'')}</div>
      <div style="color:var(--text-muted);font-size:12px;margin-bottom:6px">${esc(t.artist||'')}</div>
      <div style="display:flex;gap:5px;flex-wrap:wrap">
        ${t.bpm    ? `<span class="pill pill-bpm">${Math.round(t.bpm)}</span>`                                               : ''}
        ${t.key    ? `<span class="pill pill-key">${esc(t.key)}</span>`                                                      : ''}
        ${t.energy ? `<span class="pill pill-energy ${eC}">E${t.energy}</span>`                                              : ''}
        ${t.genre  ? `<span class="pill" style="background:var(--surface3);color:var(--text-muted);border:1px solid var(--border)">${esc(t.genre)}</span>` : ''}
      </div>
      ${tags ? `<div style="margin-top:5px;font-size:11px;color:var(--text-dim)">ğŸ· ${esc(tags)}</div>` : ''}
    `;
    tip.style.display = 'block';
    const tw = 234, th = 115;
    const cw = rect.width, ch = rect.height;
    tip.style.left = (mx + 14 + tw > cw ? mx - tw - 8 : mx + 14) + 'px';
    tip.style.top  = (my + th     > ch ? my - th      : my - 10)  + 'px';
  }

  _draw() {
    if (this._raf) return;
    this._raf = requestAnimationFrame(() => { this._raf = null; this._render(); });
  }

  _color(t) {
    switch (this.mode) {
      case 'energy': {
        const e = (t.energy || 5) / 10;
        if (e <= 0.5) {
          const f = e * 2;
          return `rgb(${Math.round(59+80*f)},${Math.round(130-38*f)},246)`;
        }
        const f = (e - 0.5) * 2;
        return `rgb(${Math.round(139+100*f)},${Math.round(92-24*f)},${Math.round(246-178*f)})`;
      }
      case 'genre': return this._gColors[t.genre || 'Other'] || '#555566';
      case 'bpm': {
        const b = Math.min(Math.max(((t.bpm||120) - 80) / 80, 0), 1);
        return `rgb(${Math.round(59+180*b)},${Math.round(130-62*b)},${Math.round(246-187*b)})`;
      }
      case 'tags': {
        const tag = (t.my_tags||[])[0];
        if (!tag) return '#444455';
        let h = 5381;
        for (let i = 0; i < tag.length; i++) h = ((h * 33) ^ tag.charCodeAt(i)) >>> 0;
        return `hsl(${h % 360},62%,56%)`;
      }
    }
    return '#8b5cf6';
  }

  _render() {
    const ctx = this.ctx;
    const w   = this.canvas.width  / this._dpr;
    const h   = this.canvas.height / this._dpr;

    ctx.clearRect(0, 0, w, h);
    ctx.fillStyle = '#0d0d0f';
    ctx.fillRect(0, 0, w, h);

    if (!this.tracks.length) return;

    const hasSet = Object.keys(this.setIds).length > 0;

    // â”€â”€ Background tracks â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    for (const t of this.tracks) {
      if (hasSet && this.setIds[t.id] !== undefined) continue;
      const { sx, sy } = this._w2s(t.x, t.y);
      if (sx < -12 || sx > w+12 || sy < -12 || sy > h+12) continue;

      const hov = this.hovered === t;
      const r   = hov ? 5.5 : 3.5;
      ctx.globalAlpha = hasSet ? 0.18 : (hov ? 1 : 0.72);
      ctx.beginPath();
      ctx.arc(sx, sy, r, 0, Math.PI * 2);
      ctx.fillStyle = this._color(t);
      ctx.fill();

      if (hov && !hasSet) {
        ctx.globalAlpha = 0.45;
        ctx.beginPath();
        ctx.arc(sx, sy, r + 3, 0, Math.PI * 2);
        ctx.strokeStyle = this._color(t);
        ctx.lineWidth = 1.5;
        ctx.stroke();
      }
    }
    ctx.globalAlpha = 1;

    // â”€â”€ Set overlay â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (hasSet) {
      const entries = Object.entries(this.setIds)
        .map(([id, pos]) => ({ id, pos, t: this.tracks.find(tr => tr.id === id) }))
        .filter(e => e.t)
        .sort((a, b) => a.pos - b.pos);

      // Dashed connection lines
      ctx.save();
      ctx.setLineDash([5, 5]);
      ctx.strokeStyle = 'rgba(139,92,246,0.45)';
      ctx.lineWidth = 1.5;
      for (let i = 0; i < entries.length - 1; i++) {
        const a = this._w2s(entries[i].t.x,   entries[i].t.y);
        const b = this._w2s(entries[i+1].t.x, entries[i+1].t.y);
        ctx.beginPath();
        ctx.moveTo(a.sx, a.sy);
        ctx.lineTo(b.sx, b.sy);
        ctx.stroke();
      }
      ctx.restore();

      // Numbered dots
      for (const { id, pos, t } of entries) {
        const { sx, sy } = this._w2s(t.x, t.y);
        if (sx < -24 || sx > w+24 || sy < -24 || sy > h+24) continue;

        const hov = this.hovered?.id === id;
        const r   = hov ? 11 : 9;

        // Radial glow
        const grd = ctx.createRadialGradient(sx, sy, 0, sx, sy, r + 9);
        grd.addColorStop(0, 'rgba(139,92,246,.55)');
        grd.addColorStop(1, 'rgba(139,92,246,0)');
        ctx.beginPath();
        ctx.arc(sx, sy, r + 9, 0, Math.PI * 2);
        ctx.fillStyle = grd;
        ctx.fill();

        // Circle fill
        ctx.beginPath();
        ctx.arc(sx, sy, r, 0, Math.PI * 2);
        ctx.fillStyle = '#8b5cf6';
        ctx.fill();
        ctx.strokeStyle = hov ? '#fff' : 'rgba(255,255,255,.85)';
        ctx.lineWidth = 1.5;
        ctx.stroke();

        // Position number
        ctx.fillStyle = '#fff';
        ctx.font = `bold 9px -apple-system, sans-serif`;
        ctx.textAlign    = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(String(pos), sx, sy);
      }
    }

    this._legend();
  }

  _legend() {
    const el = document.getElementById('map-legend');
    if (!el) return;

    let html = '';
    if (this.mode === 'energy') {
      html = `
        <div style="font-size:11px;font-weight:600;color:var(--text-dim);letter-spacing:.4px;margin-bottom:7px">ENERGY</div>
        <div style="width:72px;height:7px;border-radius:4px;background:linear-gradient(to right,#3b82f6,#8b5cf6,#ef4444);margin-bottom:4px"></div>
        <div style="display:flex;justify-content:space-between;width:72px;font-size:10px;color:var(--text-dim)"><span>Low</span><span>High</span></div>`;
    } else if (this.mode === 'genre') {
      const entries = Object.entries(this._gColors).slice(0, 10);
      html = `<div style="font-size:11px;font-weight:600;color:var(--text-dim);letter-spacing:.4px;margin-bottom:6px">GENRE</div>` +
        entries.map(([g, c]) =>
          `<div style="display:flex;align-items:center;gap:6px;margin-bottom:4px">
            <div style="width:8px;height:8px;border-radius:50%;background:${c};flex-shrink:0"></div>
            <span style="font-size:10px;color:var(--text-muted);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px">${esc(g)}</span>
          </div>`
        ).join('');
    } else if (this.mode === 'bpm') {
      html = `
        <div style="font-size:11px;font-weight:600;color:var(--text-dim);letter-spacing:.4px;margin-bottom:7px">BPM</div>
        <div style="width:72px;height:7px;border-radius:4px;background:linear-gradient(to right,#3b82f6,#f97316,#ef4444);margin-bottom:4px"></div>
        <div style="display:flex;justify-content:space-between;width:72px;font-size:10px;color:var(--text-dim)"><span>80</span><span>160</span></div>`;
    } else if (this.mode === 'tags') {
      html = `
        <div style="font-size:11px;font-weight:600;color:var(--text-dim);letter-spacing:.4px;margin-bottom:5px">MY TAGS</div>
        <div style="font-size:10px;color:var(--text-dim);line-height:1.6">Each tag<br>is a distinct hue</div>`;
    }

    const n = Object.keys(this.setIds).length;
    if (n > 0) {
      html += `
        <div style="margin-top:10px;padding-top:8px;border-top:1px solid var(--border)">
          <div style="display:flex;align-items:center;gap:6px">
            <div style="width:10px;height:10px;border-radius:50%;background:#8b5cf6;border:2px solid rgba(255,255,255,.8);flex-shrink:0"></div>
            <span style="font-size:10px;color:var(--text-muted)">${n} set tracks</span>
          </div>
          <div style="font-size:10px;color:var(--text-dim);margin-top:3px">Numbers = set order</div>
        </div>`;
    }

    el.innerHTML = html;
  }
}

// â”€â”€ Map helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadTrackMap() {
  if (state.mapLoaded) {
    trackMap?.resetView();
    return;
  }

  const statusEl  = document.getElementById('map-status');
  const loadingEl = document.getElementById('map-loading');
  loadingEl.style.display = 'flex';
  statusEl.textContent = 'Computing track mapâ€¦';

  try {
    const data = await api('/api/library/map');
    state.mapLoaded = true;

    const canvas = document.getElementById('map-canvas');
    if (!trackMap) trackMap = new TrackMap(canvas);
    trackMap.load(data);

    // Apply existing setlist overlay if one was already generated
    if (state.currentSetlist) trackMap.updateSet(state.currentSetlist);

    loadingEl.style.display = 'none';
    statusEl.textContent = `${data.length.toLocaleString()} tracks Â· scroll to zoom Â· drag to pan`;
  } catch (e) {
    loadingEl.style.display = 'none';
    statusEl.textContent = `âš  ${e.message}`;
  }
}

function setMapColorMode(mode) {
  document.querySelectorAll('.map-mode-btn').forEach(b => {
    b.classList.toggle('active', b.dataset.mode === mode);
  });
  trackMap?.setMode(mode);
}

function resetMapZoom() {
  trackMap?.resetView();
}

async function rebuildTrackMap() {
  const btn       = document.getElementById('rebuild-map-btn');
  const statusEl  = document.getElementById('map-status');
  const loadingEl = document.getElementById('map-loading');

  // Switch to map tab so the user sees the progress
  switchTab('map', null);

  state.mapLoaded = false;
  btn.disabled = true;
  loadingEl.style.display = 'flex';
  statusEl.textContent = 'Rebuilding track mapâ€¦';

  try {
    const data = await api('/api/library/map?force=true');
    state.mapLoaded = true;

    const canvas = document.getElementById('map-canvas');
    if (!trackMap) trackMap = new TrackMap(canvas);
    trackMap.load(data);

    if (state.currentSetlist) trackMap.updateSet(state.currentSetlist);

    loadingEl.style.display = 'none';
    statusEl.textContent = `${data.length.toLocaleString()} tracks Â· scroll to zoom Â· drag to pan`;
    showToast('âœ… Track map rebuilt!', 'success');
  } catch (e) {
    loadingEl.style.display = 'none';
    statusEl.textContent = `âš  Rebuild failed: ${e.message}`;
    showToast(`âŒ Rebuild failed: ${e.message}`, 'error');
  } finally {
    btn.disabled = false;
  }
}

// â”€â”€ Boot â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
init();
</script>
</body>
</html>
